name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build (compile + tests)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build
        run: ./gradlew clean build --no-daemon

  smoke-run:
    name: Smoke run sample (Linux + Xvfb)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install Linux OpenGL deps (Mesa) + Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb mesa-utils libgl1-mesa-dri libglx-mesa0 libx11-6 libxrandr2 libxinerama1 libxcursor1 libxi6

      - name: Run sample smoke task if present
        shell: bash
        run: |
          set -euo pipefail

          MODULE=":acorn-sample"
          TASK="smokeRun"

          echo "Checking for $MODULE:$TASK..."
          if ./gradlew "$MODULE:tasks" --all --no-daemon | grep -qE "^[[:space:]]*$TASK[[:space:]]"; then
            echo "Found $MODULE:$TASK, running it under Xvfb..."
            export LIBGL_ALWAYS_SOFTWARE=1
            xvfb-run -a ./gradlew "$MODULE:$TASK" --no-daemon
          else
            echo "No $MODULE:$TASK task found. Skipping run step (build already verified)."
            echo "Tip: add a dedicated smoke run task that exits automatically in CI."
          fi